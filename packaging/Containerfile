# Feedback-a-tron Container
# Build with: nerdctl build -t feedback-a-tron .
# Or: podman build -t feedback-a-tron .

# Stage 1: Build Elixir MCP server
FROM cgr.dev/chainguard/wolfi-base AS elixir-builder

RUN apk add --no-cache \
    elixir \
    erlang \
    git \
    build-base

WORKDIR /build/elixir-mcp

COPY elixir-mcp/mix.exs elixir-mcp/mix.lock ./
RUN mix local.hex --force && \
    mix local.rebar --force && \
    mix deps.get --only prod

COPY elixir-mcp/ ./
RUN MIX_ENV=prod mix release

# Stage 2: Build Julia stats (optional)
FROM cgr.dev/chainguard/wolfi-base AS julia-builder

RUN apk add --no-cache julia

WORKDIR /build/julia-stats
COPY julia-stats/ ./

# Precompile Julia packages
RUN julia --project=. -e 'using Pkg; Pkg.instantiate(); Pkg.precompile()'

# Stage 3: Runtime image
FROM cgr.dev/chainguard/wolfi-base AS runtime

# Install runtime dependencies only
RUN apk add --no-cache \
    erlang \
    julia \
    nickel

# Create non-root user
RUN adduser -D -u 1000 feedback
USER feedback
WORKDIR /home/feedback

# Copy Elixir release
COPY --from=elixir-builder --chown=feedback:feedback \
    /build/elixir-mcp/_build/prod/rel/gh_manage ./elixir-mcp/

# Copy Julia package
COPY --from=julia-builder --chown=feedback:feedback \
    /build/julia-stats ./julia-stats/

# Copy config schema
COPY --chown=feedback:feedback config/ ./config/

# Copy scripts
COPY --chown=feedback:feedback scripts/ ./scripts/

# Copy STATE.scm for reference
COPY --chown=feedback:feedback STATE.scm ./

# Create data directories
RUN mkdir -p \
    /home/feedback/.config/feedback-a-tron \
    /home/feedback/.local/share/feedback-a-tron

# Environment
ENV LANG=C.UTF-8 \
    HOME=/home/feedback \
    PATH="/home/feedback/elixir-mcp/bin:$PATH"

# Default entrypoint - MCP server mode
ENTRYPOINT ["/home/feedback/elixir-mcp/bin/gh_manage"]
CMD ["start"]

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s \
    CMD /home/feedback/elixir-mcp/bin/gh_manage pid || exit 1

# Labels
LABEL org.opencontainers.image.title="feedback-a-tron" \
      org.opencontainers.image.description="GitHub repository management with Datalog analysis" \
      org.opencontainers.image.source="https://github.com/hyperpolymath/feedback-a-tron" \
      org.opencontainers.image.licenses="Apache-2.0"
